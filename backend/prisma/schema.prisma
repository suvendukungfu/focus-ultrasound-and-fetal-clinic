generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EDITOR
  STAFF
  VIEWER
}

enum LeadStatus {
  NEW
  CONTACTED
  BOOKED
  COMPLETED
  CLOSED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  name     String
  password String
  role     Role   @default(VIEWER)

  // Enterprise fields
  isActive  Boolean   @default(true)
  version   Int       @default(1) // Optimistic locking
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  sessions  Session[]
  auditLogs AuditLog[]

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  fingerprint  String? // Device/IP fingerprint
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Lead {
  id            String     @id @default(uuid())
  name          String
  email         String?
  phone         String
  message       String?
  source        String     @default("website")
  status        LeadStatus @default(NEW)
  priorityScore Int        @default(0) // AI or heuristic score
  adminNotes    String?    @db.Text
  followUpDate  DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status, priorityScore(sort: Desc)])
  @@map("leads")
}

model Doctor {
  id             String  @id @default(uuid())
  name           String
  specialization String
  bio            String?
  imageUrl       String?
  isActive       Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  appointments Appointment[]

  @@map("doctors")
}

model Service {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Decimal?
  durationMin Int      @default(30)
  isActive    Boolean  @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  appointments Appointment[]

  @@map("services")
}

model Appointment {
  id     String            @id @default(uuid())
  date   DateTime
  status AppointmentStatus @default(PENDING)
  notes  String?

  patientName  String
  patientPhone String
  patientEmail String?

  doctorId String?
  doctor   Doctor? @relation(fields: [doctorId], references: [id])

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("appointments")
}

model BlogPost {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  content         String    @db.Text
  excerpt         String?
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  authorId        String?
  locale          String    @default("en") // 'en' or 'hi'

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([slug])
  @@index([isPublished, publishedAt])
  @@map("blog_posts")
}

model Review {
  id         String  @id @default(uuid())
  author     String
  rating     Int
  content    String?
  isApproved Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([isApproved, rating(sort: Desc)])
  @@map("reviews")
}

model AuditLog {
  id         String  @id @default(uuid())
  userId     String?
  user       User?   @relation(fields: [userId], references: [id])
  action     String // e.g., "LEAD_STATUS_UPDATED"
  entityId   String? // Target row ID
  entityType String? // e.g., "Lead"
  oldData    Json?
  newData    Json?
  ipAddress  String? @map("ip")

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model EventLog {
  id          String    @id @default(uuid())
  eventName   String
  payload     Json
  processed   Boolean   @default(false)
  error       String?   @db.Text
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([eventName, processed])
  @@map("event_logs")
}

model CacheInvalidation {
  id            String   @id @default(uuid())
  cacheKey      String
  reason        String?
  invalidatedAt DateTime @default(now())

  @@index([cacheKey])
  @@map("cache_invalidations")
}

// ==========================================
// V6: SELF-HEALING ARCHITECTURE TABLES
// ==========================================

model SystemMetric {
  id         String   @id @default(uuid())
  metricName String // e.g. "queueLoad", "apiLatency", "memoryUsage"
  value      Float
  unit       String? // e.g. "ms", "mb", "%"
  recordedAt DateTime @default(now())

  @@index([metricName, recordedAt(sort: Desc)])
  @@map("system_metrics")
}

model SystemAlert {
  id            String    @id @default(uuid())
  severity      String // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  triggerSource String // e.g. "QueueMonitor", "LatencyPredictor"
  message       String
  acknowledged  Boolean   @default(false)
  createdAt     DateTime  @default(now())
  resolvedAt    DateTime?

  @@index([severity, acknowledged])
  @@map("system_alerts")
}

model PredictiveInsight {
  id         String   @id @default(uuid())
  riskLevel  String // "SAFE", "WARNING", "HIGH_RISK"
  reason     String
  confidence Float // 0.0 to 1.0
  createdAt  DateTime @default(now())

  @@index([riskLevel])
  @@map("predictive_insights")
}

model RecoveryLog {
  id           String   @id @default(uuid())
  actionTaken  String // e.g. "scaleWorkers", "flushRedis", "pauseQueue"
  success      Boolean
  targetSystem String?
  executionMs  Int?
  createdAt    DateTime @default(now())

  @@index([actionTaken, success])
  @@map("recovery_logs")
}

// ==========================================
// V7: DISTRIBUTED MICRO-KERNEL PLATFORM
// ==========================================

model ServiceStatus {
  id          String    @id @default(uuid())
  serviceName String    @unique
  status      String // "ONLINE", "DEGRADED", "OFFLINE"
  uptime      Int
  crashes     Int       @default(0)
  lastCrashAt DateTime?
  region      String    @default("GLOBAL")
  updatedAt   DateTime  @updatedAt

  @@index([region, status])
  @@map("service_statuses")
}

model KernelEvent {
  id        String   @id @default(uuid())
  eventType String // "plugin.loaded", "service.crashed"
  payload   Json?
  region    String   @default("GLOBAL")
  createdAt DateTime @default(now())

  @@index([eventType, region])
  @@map("kernel_events")
}

model RegionMetric {
  id            String   @id @default(uuid())
  region        String
  activeNodes   Int
  queuePressure Float
  totalRequests BigInt   @default(0)
  recordedAt    DateTime @default(now())

  @@index([region, recordedAt(sort: Desc)])
  @@map("region_metrics")
}

model AIProviderStats {
  id           String   @id @default(uuid())
  providerName String // "OpenAI", "Anthropic", "Local-Llama"
  modelUsed    String
  tokensUsed   Int
  costEstimate Float    @default(0.0)
  successful   Boolean  @default(true)
  region       String   @default("GLOBAL")
  createdAt    DateTime @default(now())

  @@index([providerName, region])
  @@map("ai_provider_stats")
}
